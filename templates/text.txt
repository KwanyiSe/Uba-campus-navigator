from django.db import models

class SiteVisit(models.Model):
    """
    Stores one record per unique browser session.

    We use Django's session_key as a proxy for a unique visitor.
    This is the most accurate approach WITHOUT user authentication.
    """

    # Unique browser session identifier
    session_key = models.CharField(max_length=40, unique=True)

    # When the visitor first appeared on the site
    first_visit = models.DateTimeField(auto_now_add=True)

    # Updated automatically on every request
    last_visit = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.session_key



———————-

from django.db import IntegrityError
from .models import SiteVisit

class SiteVisitMiddleware:
    """
    Tracks unique visitors using Django sessions.

    - Ensures a session exists
    - Creates ONE SiteVisit per session
    - Handles race conditions safely
    """

    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # Ensure the user has a session
        if not request.session.session_key:
            request.session.create()

        session_key = request.session.session_key

        try:
            # Create the visitor if it does not exist
            SiteVisit.objects.get_or_create(session_key=session_key)
        except IntegrityError:
            # Handles rare race condition:
            # two requests creating same session simultaneously
            pass

        return self.get_response(request)


———————-

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',

    # REQUIRED: sessions must run before our tracking middleware
    'django.contrib.sessions.middleware.SessionMiddleware',

    # Custom visitor tracking
    'campus.middleware.SiteVisitMiddleware',

    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
]

——————

from django.utils import timezone
from .models import SiteVisit

def admin_index(request):
    """
    Calculates anonymous visitor statistics.

    Definitions:
    - total_visitors: all unique sessions ever seen
    - visitors_today: first-time visitors today
    - returning_visitors: visitors who first visited before today
    """

    today = timezone.now().date()

    total_visitors = SiteVisit.objects.count()

    visitors_today = SiteVisit.objects.filter(
        first_visit__date=today
    ).count()

    returning_visitors = SiteVisit.objects.filter(
        first_visit__date__lt=today
    ).count()

    return {
        "total_visitors": total_visitors,
        "visitors_today": visitors_today,
        "returning_visitors": returning_visitors,
    }




———————-

{% extends "admin/index.html" %}

{% block content %}

<!-- ===== Site Statistics ===== -->
<div class="dashboard-module" style="margin-bottom: 20px;">
  <h2>Site Statistics</h2>

  <ul style="list-style: none; padding-left: 0;">
    <li>
      <strong>Unique Visitors:</strong>
      {{ total_visitors|default:"0" }}
    </li>
    <li>
      <strong>Visitors Today:</strong>
      {{ visitors_today|default:"0" }}
    </li>
    <li>
      <strong>Returning Visitors:</strong>
      {{ returning_visitors|default:"0" }}
    </li>
  </ul>

  <p style="color: #666; font-size: 12px;">
    Based on anonymous browser sessions (no login required).
  </p>
</div>
<!-- ===== End Site Statistics ===== -->

{{ block.super }}

{% endblock %}

