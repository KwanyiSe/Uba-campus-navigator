<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>University of Bamenda — Campus Map</title>

{% load static %}

<!-- linking for progressive web app (PWA) -->
<link rel="manifest" href="{% static 'manifest.json' %}">
<meta name="theme-color" content="#0b1220">

 <!-- Google  analytics -tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7RT1071LD5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-7RT1071LD5');
</script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<!-- Geocoder -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<style>
html,body{
  height:100%;margin:0;
  font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;
  background:#071022;color:#e6eef8;overflow:hidden;
}

/* ---------------- SPLASH ---------------- */
#splash {
  position: fixed; inset: 0;
  background: #1a1a1a;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 20000;
}
.spinner {
  width: 32px; height: 32px; border-radius: 50%;
  border: 4px solid rgba(255,255,255,0.25);
  border-top-color: #cfcfcf;
  animation: spin 1s linear infinite;
  margin-bottom: 18px;
}
#splash-title {
  font-size: 22px; font-weight:700; color:#f48b23;
  margin-bottom: 35px; /* to bring the  campus txt and spinner down*/
}
#splash-logo-box {
  position:absolute;bottom:38px;text-align:center;
}
#splash-logo-box img { width:120px;margin-bottom:6px; }
#splash-logo-text {
  color:#fff;font-size:16px;font-weight:600;letter-spacing:.5px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ---------------- HEADER ---------------- */
#headerBar {
  position:fixed;top:0;left:0;right:0;height:56px;
  background:#0b1220;z-index:10010;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 6px 18px rgba(2,6,23,0.6);
}
#themeBtn{
  position:absolute;left:12px;top:9px;width:38px;height:38px;
  border-radius:8px;background:#111827;border:none;color:white;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
  transition:0.15s;
}

/* ---------------- SEARCH ---------------- */
#searchContainer{
  position:fixed;top:66px;left:50%;transform:translateX(-50%);
  width:calc(100% - 28px);max-width:700px;z-index:10009;
  display:flex;gap:8px;padding:8px;
}

#searchBox{
  flex:1;background:#fff;border-radius:12px;padding:6px 8px;
  display:flex;align-items:center;
  box-shadow:0 8px 24px rgba(2,6,23,0.4);
}

#buildingSearch{
  flex:1;border:0;outline:none;font-size:15px;padding:10px;
  background:white;color:black;
}

#searchBtn{
  background:#1f2937;color:#fff;border:none;
  padding:10px 14px;border-radius:10px;font-weight:700;
  cursor:pointer;
  transition:0.15s;
}

/* -------- MOBILE FIX -------- */
@media(max-width:480px){
  #searchContainer{ flex-direction:column; }
  #searchBtn{ width:100%;padding:12px; }
}

/* AUTOCOMPLETE */
#suggestions{
  position:absolute;top:52px;left:8px;right:8px;background:#fff;
  border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.24);
  max-height:230px;overflow:auto;display:none;z-index:20000;
}
.suggestion-item{
  padding:10px 12px;border-bottom:1px solid rgba(0,0,0,0.06);
  cursor:pointer;font-size:14px;color:#111;
}
.suggestion-item:hover{ background:#f3f4f6; }

/* MAP */
#map{
  position:fixed;top:0;bottom:0;left:0;right:0;z-index:1;
}

/* BLUR OUTSIDE */
.leaflet-blur-mask {
  filter: blur(4px) brightness(55%);
  pointer-events: none;
}

/* FLOAT BUTTONS */
.floatBtn{
  position:fixed;right:12px;z-index:10009;border:none;color:#fff;
  padding:10px 12px;border-radius:10px;font-weight:700;
  background:#111827; cursor:pointer;
  box-shadow:0 6px 18px rgba(2,6,23,0.6);
  transition:0.15s;
}

#locateBtn{ top:140px }
#stopNavigationBtn{ top:200px; display:none; }
#aboutBtn{ top:260px }

/* MOVE ZOOM BTN */
.leaflet-control-zoom{
  bottom:40px !important;
  top:auto !important;
  left:12px !important;
  right:auto !important;
}

/* ROUTE BOX */
#routeInfo{
  position:fixed;left:0;right:0;bottom:0;z-index:10009;
  background:rgba(2,6,23,0.95);padding:12px 14px;
  display:none;color:#e6eef8;
}
#routeSteps{
  margin-top:8px;max-height:180px;overflow:auto;
  color:#cfe7ff;font-size:13px;
}

/* TOAST */
#toast{
  position:fixed;left:50%;top:120px;transform:translateX(-50%);
  background:rgba(8,10,14,0.96);padding:8px 12px;
  border-radius:8px;color:#fff;display:none;z-index:10050;
}

/* POPUP BUTTONS */
.popup-btn{
  width:100%;background:#1f2937;color:#fff;border:none;
  padding:8px;margin-top:6px;border-radius:8px;font-size:14px;
  cursor:pointer;transition:0.15s;
}
.popup-btn:hover{ background:#374151; }

/* UNIVERSAL CLICK EFFECT */
button:active, .popup-btn:active {
  transform: scale(0.94);
  box-shadow:0 2px 6px rgba(0,0,0,0.5);
  transition:0.08s ease;
}

/* ABOUT MODAL */
.about-modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.6);
  display:none;justify-content:center;align-items:center;
  z-index:20000;
}
.about-content{
  background:#111827;color:white;
  width:85%;max-width:340px;padding:20px;
  border-radius:12px;text-align:center;
  box-shadow:0 8px 24px rgba(0,0,0,0.5);
}
.about-content h2{ margin-top:0; }
.about-content a{ color:#3b82f6;font-weight:600; }

</style>
</head>

<body>

<!-- SPLASH -->
<div id="splash">
  <div class="spinner"></div>
  <div id="splash-title">Campus map</div>
  <div id="splash-logo-box">
    <img src="{% static 'blur_uba_logo.png' %}" alt="UBA" />
    <div id="splash-logo-text">UNIVERSITY OF BAMENDA</div>
  </div>
</div>

<!-- HEADER -->
<div id="headerBar">
  <button id="themeBtn"></button>
  <div id="titleText">University of Bamenda</div>
</div>

<!-- SEARCH -->
<div id="searchContainer">
  <div id="searchBox">
    <input id="buildingSearch" type="text" placeholder="Search building..." autocomplete="off" />
    <div id="suggestions"></div>
  </div>
  <button id="searchBtn">Search</button>
</div>

<!-- MAP -->
<div id="map"></div>

<!-- FLOATING BUTTONS -->
<button id="locateBtn" class="floatBtn">Locate Me</button>
<button id="stopNavigationBtn" class="floatBtn">Stop Navigation</button>
<button id="aboutBtn" class="floatBtn">About</button>

<button id="installBtn" class="floatBtn" style="top:320px;display:none;">
  Install App
</button>


<!-- ROUTE INFO -->
<div id="routeInfo">
  <div id="routeSummary">
    <b>Distance:</b> <span id="distVal">—</span> &nbsp;
    <b>Duration:</b> <span id="durVal">—</span>
  </div>
  <div id="routeSteps"></div>
</div>

<div id="toast"></div>

<!-- ABOUT MODAL -->
<div id="aboutModal" class="about-modal">
  <div class="about-content">
    <h2>About the Developer</h2>
    <p>
      Developed by <b>Kwanyi Sedrick Bodeh</b><br>
      <span style="opacity:0.6;">sedrickbodeh654@gmail.com</span>
    </p>
    <button id="closeAbout" class="popup-btn">Close</button>
  </div>
</div>


<script>
const API_URL = "/api/buildings/";
const ROUTE_URL = "/api/route/";

/* MAP INIT */
const map = L.map("map", { zoomControl: true }).setView([6.011, 10.2595], 17);

const satellite = L.tileLayer(
  "https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}", { maxZoom:20 }
).addTo(map);

const dark = L.tileLayer(
  "https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", { maxZoom:20 }
);

let currentBase = "satellite";

/* THEME SWITCH */
const themeBtn = document.getElementById("themeBtn");
function applyTheme(){
  themeBtn.innerHTML = currentBase === "satellite"
    ? `<svg viewBox="0 0 24 24" width="18"><path fill="none" stroke="white" stroke-width="1.6"
       d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>`
    : `<svg viewBox="0 0 24 24" width="18" fill="none" stroke="white" stroke-width="1.6">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a8 8 0 00-14.8 0"/></svg>`;
}
themeBtn.onclick = () => {
  if(currentBase === "satellite"){ map.removeLayer(satellite); dark.addTo(map); currentBase="dark"; }
  else{ map.removeLayer(dark); satellite.addTo(map); currentBase="satellite"; }
  applyTheme();
};
applyTheme();

/* BOUNDARY LOCK */
const campusBoundary = [
  [6.01750, 10.25240],
  [6.01610, 10.26820],
  [6.00610, 10.26840],
  [6.00500, 10.25220],
];
const bounds = L.latLngBounds(campusBoundary);
map.setMaxBounds(bounds.pad(0.01));
map.fitBounds(bounds);

/* BLUR OUTSIDE */
const world = [
  [-90,-180],[-90,180],[90,180],[90,-180]
];

L.polygon([world, campusBoundary], {
  fillColor:"#000",
  fillOpacity:0.65,
  stroke:false,
  interactive:false,
  className:"leaflet-blur-mask"
}).addTo(map);

/* LOAD BUILDINGS */
let buildingMarkers = [];
const cluster = L.markerClusterGroup();

fetch(API_URL)
.then(r => r.json())
.then(data => {
  data.forEach(b => {
    const icon = L.icon({
      iconUrl:"https://cdn-icons-png.flaticon.com/512/854/854878.png",
      iconSize:[36,36], iconAnchor:[18,36]
    });

    const marker = L.marker([b.latitude, b.longitude], { icon });

    marker.bindPopup(`
      <div style="min-width:180px">
        <div style="font-weight:700;margin-bottom:6px;">${b.name}</div>
        <div style="color:#6b7280;font-size:13px;margin-bottom:8px;">${b.description||""}</div>
        <button class="popup-btn" onclick="setStart(${b.latitude},${b.longitude})">Set Start</button>
        <button class="popup-btn" onclick="setEnd(${b.latitude},${b.longitude})">Set Destination</button>
        <button class="popup-btn" onclick="navigateFromPopup(${b.latitude},${b.longitude})">Navigate</button>
      </div>
    `);

    cluster.addLayer(marker);
    buildingMarkers.push({ name:b.name, marker, lat:b.latitude, lng:b.longitude });
  });

  map.addLayer(cluster);
})
.catch(() => showToast("Failed loading buildings"));

/* AUTOCOMPLETE */
const input = document.getElementById("buildingSearch");
const suggestions = document.getElementById("suggestions");

input.addEventListener("input", () => {
  const q = input.value.trim().toLowerCase();
  if(!q){ suggestions.style.display="none"; return; }

  const match = buildingMarkers.filter(b => b.name.toLowerCase().includes(q)).slice(0,8);

  suggestions.innerHTML = "";
  match.forEach(m => {
    const div = document.createElement("div");
    div.className="suggestion-item";
    div.innerText=m.name;
    div.onclick = () => {
      input.value=m.name;
      suggestions.style.display="none";
      map.setView([m.lat,m.lng], 19);
      m.marker.openPopup();
    };
    suggestions.appendChild(div);
  });

  suggestions.style.display="block";
});

document.addEventListener("click", e => {
  if(!document.getElementById("searchContainer").contains(e.target)){
    suggestions.style.display="none";
  }
});

/* SEARCH BUTTON */
document.getElementById("searchBtn").onclick = () => {
  const q = input.value.trim().toLowerCase();
  if(!q){ showToast("Enter a building name"); return; }
  const found = buildingMarkers.find(b => b.name.toLowerCase() === q);
  if(!found){ showToast("Building not found"); return; }
  map.setView([found.lat,found.lng], 19);
  found.marker.openPopup();
};

/* USER LOCATION */
let userMarker = null;
map.on("locationfound", e => {
  if(!userMarker){
    userMarker = L.marker(e.latlng, {
      icon:L.icon({
        iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png",
        iconSize:[36,36], iconAnchor:[18,18]
      })
    }).addTo(map);
  } else {
    userMarker.setLatLng(e.latlng);
  }
});
map.locate({watch:true,enableHighAccuracy:true});

document.getElementById("locateBtn").onclick = () => {
  if(!userMarker){ showToast("Location not ready"); return; }
  map.setView(userMarker.getLatLng(), 18);
};

/* ROUTING */
let routeStart = null;
let routeEnd = null;
let routeLine = null;

/* Stop Nav Button */
const stopBtn = document.getElementById("stopNavigationBtn");

function setStart(lat,lng){
  routeStart = L.latLng(lat,lng);
  showToast("Start set");
}
function setEnd(lat,lng){
  routeEnd = L.latLng(lat,lng);
  showToast("Destination set");
}

function navigateFromPopup(lat,lng){
  setEnd(lat,lng);
  if(!routeStart && userMarker) routeStart = userMarker.getLatLng();
  if(!routeStart){ showToast("Waiting for GPS..."); return; }
  navigateRoute();
}

async function navigateRoute(){
  if(!routeStart || !routeEnd){ showToast("Missing location"); return; }

  const url = `${ROUTE_URL}?start=${routeStart.lat},${routeStart.lng}&end=${routeEnd.lat},${routeEnd.lng}`;
  const res = await fetch(url);
  if(!res.ok){ showToast("Route failed"); return; }

  const data = await res.json();
  const coords = data.coordinates.map(c => [c[1],c[0]]);

  if(routeLine) map.removeLayer(routeLine);

  routeLine = L.polyline(coords, { color:"#60a5fa", weight:6 }).addTo(map);
  map.fitBounds(routeLine.getBounds(),{padding:[40,120]});

  document.getElementById("distVal").innerText = Math.round(data.distance)+" m";
  document.getElementById("durVal").innerText = data.duration;

  document.getElementById("routeInfo").style.display="block";

  /* show stop button */
  stopBtn.style.display = "block";
}

/* STOP NAVIGATION */
stopBtn.onclick = () => {
  if(routeLine) map.removeLayer(routeLine);
  routeLine=null;
  routeStart=null;
  routeEnd=null;
  document.getElementById("routeInfo").style.display="none";
  stopBtn.style.display="none";
  showToast("Navigation cleared");
};

/* TOAST */
function showToast(msg){
  const t=document.getElementById("toast");
  t.innerText=msg;
  t.style.display="block";
  clearTimeout(t._hide);
  t._hide=setTimeout(()=>t.style.display="none",2000);
}

/* FOOTER TAG */
map.attributionControl.addAttribution("&nbsp;@University of Bamenda ");


/* ABOUT MODAL */
document.getElementById("aboutBtn").onclick = () => {
  document.getElementById("aboutModal").style.display = "flex";
}
document.getElementById("closeAbout").onclick = () => {
  document.getElementById("aboutModal").style.display = "none";
}

/* SPLASH EXIT */
window.onload = () => {
  setTimeout(()=>{
    const s=document.getElementById("splash");
    s.style.transition="opacity 450ms";
    s.style.opacity="0";
    setTimeout(()=>s.remove(),500);
  },2000);
};


/* INSTALL LOGIC */
let deferredPrompt;
const installBtn = document.getElementById("installBtn");

window.addEventListener("beforeinstallprompt", e => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = "block";

  // Analytics
  gtag('event', 'pwa_install_prompt_shown');
});

installBtn.onclick = async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const result = await deferredPrompt.userChoice;

  if (result.outcome === "accepted") {
    gtag('event', 'pwa_installed');
  }

  deferredPrompt = null;
  installBtn.style.display = "none";
};


</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/service-worker.js")
    .then(() => console.log("PWA ready"))
    .catch(err => console.error("SW error", err));
}
</script>

</body>
</html>
