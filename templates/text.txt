class DailyStats(models.Model):
    """
    Stores aggregated visitor counts per day.
    This prevents numbers from dropping due to session expiry.
    """

    date = models.DateField(unique=True)
    visitors = models.PositiveIntegerField(default=0)

    def __str__(self):
        return str(self.date)








from django.db import IntegrityError
from django.utils import timezone
from .models import SiteVisit, DailyStats

class SiteVisitMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # Ignore admin & static files
        if request.path.startswith("/admin/") or request.path.startswith("/static/"):
            return self.get_response(request)

        # Ensure session exists
        if not request.session.session_key:
            request.session.create()

        session_key = request.session.session_key

        # ---- EXISTING LOGIC (KEEP) ----
        try:
            SiteVisit.objects.get_or_create(session_key=session_key)
        except IntegrityError:
            pass

        # ---- NEW DAILY AGGREGATION LOGIC ----
        today = timezone.now().date()

        # Create today's stats row if it doesn't exist
        stats, _ = DailyStats.objects.get_or_create(date=today)

        # Count this visitor only once per day
        if not request.session.get("counted_today"):
            stats.visitors += 1
            stats.save()
            request.session["counted_today"] = True

        return self.get_response(request)











@admin.register(DailyStats, site=campus_admin_site)
class DailyStatsAdmin(admin.ModelAdmin):
    list_display = ("date", "visitors")
    ordering = ("-date",)






from django.utils import timezone
from .models import DailyStats

def admin_index(request):
    """
    Admin dashboard statistics.
    Uses DailyStats for stable numbers.
    """

    if not request.user.is_superuser:
        return {}

    today = timezone.now().date()

    total_visitors = DailyStats.objects.aggregate(
        total=models.Sum("visitors")
    )["total"] or 0

    visitors_today = DailyStats.objects.filter(
        date=today
    ).first()

    visitors_today = visitors_today.visitors if visitors_today else 0

    return {
        "total_visitors": total_visitors,
        "visitors_today": visitors_today,
    }



